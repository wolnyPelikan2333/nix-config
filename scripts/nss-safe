#!/usr/bin/env bash
set -euo pipefail

# =============================
# NSS SAFE ‚Äî TRYB DECYZYJNY
# =============================

SYSTEM_ROOT="/etc/nixos"
REPO_ROOT="/etc/nixos"
HOST="$(hostname)"

# ---------- FLAGS ----------
DRY=0
PANIC=0

for arg in "$@"; do
  case "$arg" in
  --dry) DRY=1 ;;
  --panic) PANIC=1 ;;
  esac
done

# ---------- COLORS ----------
RED="\033[31m"
YELLOW="\033[33m"
GREEN="\033[32m"
RESET="\033[0m"

fail() {
  echo -e "${RED}‚ùå $1${RESET}"
  exit 1
}
warn() { echo -e "${YELLOW}‚ö†Ô∏è  $1${RESET}"; }
ok() { echo -e "${GREEN}‚úÖ $1${RESET}"; }

header() {
  echo
  echo "=============================="
  echo "üõ°  NSS ‚Äî TRYB DECYZYJNY"
  echo "=============================="
  echo
}

# ---------- HEADER ----------
header

# ---------- PANIC ----------
if [[ "$PANIC" -eq 1 ]]; then
  echo "üßØ PANIC MODE: rollback"
  sudo nixos-rebuild switch --rollback || fail "Rollback failed"
  ok "Rollback OK"
  exit 0
fi

[[ "$DRY" -eq 1 ]] && warn "DRY RUN: brak zmian w systemie"

# ---------- SANITY ----------
[[ -d "$SYSTEM_ROOT" ]] || fail "SYSTEM_ROOT nie istnieje"
[[ -d "$REPO_ROOT/.git" ]] || fail "REPO_ROOT nie jest repozytorium git"

# ---------- REPO INFO ----------
echo "üì¶ Repo: $REPO_ROOT"
echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
(
  cd "$REPO_ROOT"
  git status --short || true
)
echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"

# ---------- MENU (DECISION FIRST) ----------

echo "Co chcesz zrobiƒá?"
echo
echo "[N] NIC nie zmieniaƒá w systemie"
echo "[S] ZMIENIƒÜ system (switch)"
echo
echo "[D] abort (domy≈õlne)"
echo

read -r -p "Wyb√≥r: " DECISION
DECISION="${DECISION:-D}"

case "$DECISION" in
N | n)
  echo
  echo "Tryby BEZ ZMIAN w systemie:"
  echo
  echo "[A] build (sprawd≈∫, czy siƒô buduje)"
  echo "[V] build-vm (test w maszynie wirtualnej)"
  echo
  echo "[D] abort (domy≈õlne)"
  echo

  read -r -p "Wyb√≥r: " CHOICE
  CHOICE="${CHOICE:-D}"

  case "$CHOICE" in
  A | a) MODE="build" ;;
  V | v) MODE="vm" ;;
  *) fail "Abort by user" ;;
  esac
  ;;
S | s)
  echo
  echo "Tryby ZMIENIAJƒÑCE system:"
  echo
  echo "[B] build + switch"
  echo "[C] build + switch + commit + push (wymaga: ga)"
  echo
  echo "[D] abort (domy≈õlne)"
  echo

  read -r -p "Wyb√≥r: " CHOICE
  CHOICE="${CHOICE:-D}"

  case "$CHOICE" in
  B | b) MODE="switch" ;;
  C | c) MODE="commit" ;;
  *) fail "Abort by user" ;;
  esac
  ;;
*)
  fail "Abort by user"
  ;;
esac

ok "Wybrany tryb: $MODE"
# ---------- BUILD ----------
echo
echo "üèó  BUILD: nix build (system)"
if [[ "$DRY" -eq 1 ]]; then
  warn "DRY: pomijam build"
else
  nix build "$SYSTEM_ROOT#nixosConfigurations.$HOST.config.system.build.toplevel" ||
    fail "Build failed"
  ok "Build OK"
fi

# ---------- BUILD-VM ----------
if [[ "$MODE" == "vm" ]]; then
  echo
  echo "üñ•  BUILD-VM: nixos-rebuild build-vm"

  if [[ "$DRY" -eq 1 ]]; then
    warn "DRY: pomijam build-vm"
  else
    nixos-rebuild build-vm --flake "$SYSTEM_ROOT#$HOST" ||
      fail "Build-VM failed"

    ok "Build-VM OK"
    echo
    echo "Uruchom VM poleceniem:"
    echo "  ./result/bin/run-*-vm"
  fi

  exit 0
fi

# ---------- SWITCH ----------
if [[ "$MODE" == "switch" || "$MODE" == "commit" ]]; then
  echo
  echo "üîÅ SWITCH: nixos-rebuild switch"
  if [[ "$DRY" -eq 1 ]]; then
    warn "DRY: pomijam switch"
  else
    sudo nixos-rebuild switch --flake "$SYSTEM_ROOT#$HOST" ||
      fail "Switch failed"
    ok "Switch OK"
  fi
fi

# ---------- COMMIT ----------
if [[ "$MODE" == "commit" && "$DRY" -eq 0 ]]; then
  echo
  echo "üì¶ COMMIT CHECK"

  (
    cd "$REPO_ROOT"

    echo
    echo "üîç Aktualny stan repo:"
    git status
    echo

    read -r -p "Dodaƒá wszystkie zmiany do staging? (t/N): " ADDALL
    ADDALL="${ADDALL:-N}"

    if [[ "$ADDALL" == "t" || "$ADDALL" == "T" ]]; then
      git add -A || fail "git add failed"
      ok "Zmiany dodane do staging"
    else
      fail "Przerwano ‚Äî brak staging"
    fi

    if git diff --cached --quiet; then
      fail "Brak zmian do commita"
    fi

    read -r -p "Commit message: " MSG
    [[ -z "$MSG" ]] && fail "Commit message pusta"

    git commit -m "$MSG" || fail "Commit failed"
    git push || fail "Push failed"
  )

  ok "Commit + push OK"
fi

# ---------- FINAL SAFETY ----------
echo
read -r -p "Kontynuowaƒá? (wpisz 'zamykamy' aby przerwaƒá): " LAST
if [[ "$LAST" == "zamykamy" ]]; then
  fail "Przerwano has≈Çem awaryjnym"
fi

ok "NSS zako≈Ñczony pomy≈õlnie"
